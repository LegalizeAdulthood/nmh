# Common helper routines for test shell scripts -- intended to be sourced by them
# @configure_input@


#### The following exported variables are set by "make check".  Ensure
#### that they are set here so that individual tests can be run
#### outside of make.  Requires that MH_OBJ_DIR be set on entry.
test -z "$MH_TEST_DIR"  &&  MH_TEST_DIR="$MH_OBJ_DIR/test/testdir"
test -z "$prefix"  &&  prefix=@prefix@
test -z "$datarootdir"  &&  datarootdir=@datarootdir@
test -z "$exec_prefix"  &&  exec_prefix=@exec_prefix@
test -z "$auxexecdir"  &&  auxexecdir="@libdir@"
test -z "$bindir"  &&  bindir="@bindir@"
test -z "$mandir"  &&  mandir="@mandir@"
test -z "$sysconfdir"  &&  sysconfdir="@sysconfdir@"
export MH_TEST_DIR auxexecdir bindir mandir sysconfdir

test -z "$MH_INST_DIR"  &&  MH_INST_DIR=${MH_TEST_DIR}/inst
export MH_INST_DIR


output_md5()
{
  @MD5SUM@ $* | @MD5FMT@
}

test_skip ()
{
  WHY="$1"
  echo "$Test $0 SKIP ($WHY)"
  exit 77
}

# portable implementation of 'which' utility
findprog()
{
  FOUND=
  PROG="$1"
  IFS_SAVE="$IFS"
  IFS=:
  for D in $PATH; do
    if [ -z "$D" ]; then
      D=.
    fi
    if [ -f "$D/$PROG" ] && [ -x "$D/$PROG" ]; then
      printf '%s\n' "$D/$PROG"
      break
    fi
  done
  IFS="$IFS_SAVE"
}

require_prog ()
{
  if [ -z "$(findprog $1)" ]; then
    test_skip "missing $1"
  fi
}

# Some stuff for doing silly progress indicators
progress_update ()
{
  THIS="$1"
  FIRST="$2"
  LAST="$3"
  RANGE="$(($LAST - $FIRST))"
  PROG="$(($THIS - $FIRST))"
  # this automatically rounds to nearest integer
  PERC="$(((100 * $PROG) / $RANGE))"
  # note \r so next update will overwrite
  printf "%3d%%\r" $PERC
}

progress_done ()
{
  printf "100%%\n"
}

#### check() requires two arguments, each the name of a file to be
#### diff'ed.
#### If the same, the second file is removed.  And the first file is
####   removed unless the optional third argument has a value of
####   'keep first'.
#### If different, global variable "failed" is incremented.
check() {
    #### POSIX diff should support -c.
    if diff -c "$1" "$2"; then
      test $# -lt 3 -o "$3" != 'keep first'  &&  rm -f "$1"
      rm -f "$2"
    else
      echo "$0: test failed, outputs are in $1 and $2."
      failed=`expr ${failed:-0} + 1`
    fi
}

#### check_string() requires two arguments, the first is a program and
#### arguments, the second is its expected one-line output string.  If
#### the actual output does not match that string, an error message is
#### printed and global variable "failed" is incremented.
check_string() {
  #### Invert exit status to prevent triggering immediate exit due to set -e.
  ! actual_output=`$1 2>&1`
  if test "$actual_output" != "$2"; then
    echo "$0: \"$1\" should have produced:" 1>&2
    echo "    $2" 1>&2
    echo "but instead produced:" 1>&2
    echo "    $actual_output" 1>&2
    failed=`expr ${failed:-0} + 1`
  fi
}

setup_test ()
{
  export MH=${MH_TEST_DIR}/Mail/.mh_profile
  export MHMTSCONF=${MH_INST_DIR}${sysconfdir}/mts.conf
  export PATH=${MH_INST_DIR}${bindir}:${PATH}
  export MH_LIB_DIR=${MH_INST_DIR}${auxexecdir}

  #
  # Only install once
  #
  if [ ! -d ${MH_INST_DIR}${bindir} ]; then
    (cd ${MH_OBJ_DIR} && make DESTDIR=${MH_INST_DIR} install) || exit 1
  fi

  # clean old test data
  trap "rm -rf $MH_TEST_DIR/Mail; exit \$status" 0
  # setup test data
  mkdir $MH_TEST_DIR/Mail || exit 1
  cat > $MH <<EOF || exit 1
Path: ${MH_TEST_DIR}/Mail
mhlproc: ${MH_LIB_DIR}/mhl
EOF

  for f in MailAliases components digestcomps distcomps forwcomps mhl.body \
  	   mhl.digest mhl.format mhl.forward mhl.headers mhl.reply \
	   mhn.defaults rcvdistcomps replcomps replgroupcomps scan.MMDDYY \
	   scan.YYYYMMDD scan.default scan.mailx scan.nomime scan.size \
	   scan.time scan.timely scan.unseen
  do
    cp ${MH_INST_DIR}${sysconfdir}/${f} ${MH_TEST_DIR}/Mail || exit 1
  done

  folder -create +inbox > /dev/null
  # create 10 basic messages
  for i in 1 2 3 4 5 6 7 8 9 10;
  do
    cat > $MH_TEST_DIR/Mail/inbox/$i <<EOF || exit 1
From: Test$i <test$i@example.com>
To: Some User <user@example.com>
Date: Fri, 29 Sep 2006 00:00:00
Subject: Testing message $i

This is message number $i
EOF
  done
}
